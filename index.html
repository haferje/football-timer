<html>
	<header>
		<title></title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.min.js"></script>
		<script src="https://lodash.com/vendor/cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
		<style>
			.grid-container {
				display: grid;
				height: 100%;
				grid-template-columns: 1fr 1fr;
				grid-template-rows: 1fr 1fr;
				grid-gap: 1px 1px;
				grid-template-areas: "buttons pie" "bar bar";
			}

			.buttons { grid-area: buttons; }

			.pie { grid-area: pie; }

			.bar { grid-area: bar; }

			button {
				width: 100px;
				height: 100px;
			}
			button.active {
				border-style: inset;
			}
		</style>
	</header>
	<body>

		<div class="grid-container">
			<div class="buttons">
				<button id="gameplay">Game play</button>
				<button id="betweenplay">Between play</button>
				<button id="replay">Replay</button>
				<button id="timeout">Timeout</button>
				<button id="commercials">Commercials</button>
			</div>
			<div class="pie">
				<canvas id="pieChart"></canvas>
			</div>
			<div class="bar">
				<canvas id="barChart"></canvas>
			</div>
		</div>



	</body>
	<script>
		/*
			TODO:
			render total time
		*/
		class Clock {
			constructor(id, color) {
				let self = this;

				this.id = id;
				this.color = color;
				this.button = document.getElementById(id);

				this.button.onclick = function() {
					// activate button
					var btns = document.querySelectorAll("button");
					_.each(btns, btn => { btn.classList.remove("active")});
					this.classList.add("active");

					// change clocks
					timer.change(self);
				};
			}
		}

		class Timer {
			constructor() {
				this.clock = null;
				this.startTime = new Date();
				this.history = [];
			}

			change(clock) {
				// if same clock
				if (clock === this.clock)
					return;

				this.lap();
				this.clock = clock;
				this.reset();
			}

			lap() {
				if (this.clock == null)
					return;

				this.history.push({
					clock: this.clock,
					elapsed: this.elapsed(),
				});
			}

			reset() {
				this.startTime = new Date();
			}

			elapsed() {
				const now = new Date();
				const elapsed = now - this.startTime; // in ms
				return elapsed;
			}

			laps() {
				if (this.clock == null)
					return [];

				// historic data
				let history = this.history.slice(0);

				// current clock
				history.push({
					clock: this.clock,
					elapsed: this.elapsed(),
				});

				return history;
			}
		}

		class PieChart {
			constructor() {
				this.chart = new Chart("pieChart", {
					type: 'pie',
					data: {
						datasets: [{
							data: this.getData(),
							backgroundColor: [
								window.chartColors[gameplay.color],
								window.chartColors[betweenplay.color],
								window.chartColors[replay.color],
								window.chartColors[timeout.color],
								window.chartColors[commercials.color],
							],
						}],
						labels: [
							gameplay.id,
							betweenplay.id,
							replay.id,
							timeout.id,
							commercials.id,
						],
					},
					options: {
						tooltips: {
							callbacks: {
								// custom tooltip to render "Label: HhMmSs"
								label: function(tooltipItem, data) {
									var label = data.labels[tooltipItem.index];
									var value = data.datasets[0].data[tooltipItem.index];

									var seconds = Math.round(value/1000);

									var s = seconds % 60;
									var m = Math.floor(seconds / 60) % 60;
									var h = Math.floor(seconds / (60*60));

									return `${label}: ${h}h${m}m${s}s`;
								}
							}
						}
					}
				});
			}

			getData() {
				let laps = timer.laps();

				return [
					_(laps).filter({ clock: gameplay }).sumBy("elapsed"),
					_(laps).filter({ clock: betweenplay }).sumBy("elapsed"),
					_(laps).filter({ clock: replay }).sumBy("elapsed"),
					_(laps).filter({ clock: timeout }).sumBy("elapsed"),
					_(laps).filter({ clock: commercials }).sumBy("elapsed"),
				];
			}

			update() {
				this.chart.data.datasets[0].data = this.getData();
				this.chart.update();
			}
		};

		class BarChart {
			constructor() {
				this.chart = new Chart("barChart", {
					type: 'bar',
					data: {
						datasets: this.getData(),
					},
					options: {
						maintainAspectRatio: false,
						legend: {
							display: false,
						},
						animation: {
							duration: 0,
						},
						scales: {
							yAxes: [{
								ticks: {
									beginAtZero: true,
								}
							}]
						},
						tooltips: {
							callbacks: {
								// custom tooltip to render "Label: HhMmSs"
								label: function(tooltipItem, data) {
									var label = data.datasets[tooltipItem.datasetIndex].label;
									var value = data.datasets[tooltipItem.datasetIndex].data[0];
									console.log(value);

									// var seconds = Math.round(value/1000);
									// data is already in seconds
									var seconds = value;

									var s = seconds % 60;
									var m = Math.floor(seconds / 60) % 60;
									var h = Math.floor(seconds / (60*60));

									return `${label}: ${h}h${m}m${s}s`;
								}
							}
						},
					}
				});
			}

			getData() {
				let laps = timer.laps();

				let datasets = _.map(laps, lap => ({
						label: lap.clock.id,
						data: [ Math.round(lap.elapsed/1000) ],
						backgroundColor: window.chartColors[lap.clock.color],
					})
				);

				return datasets;
			}

			update() {
				this.chart.data.datasets = this.getData();
				this.chart.update();
			}
		};



		let timer = new Timer();

		let gameplay = new Clock("gameplay", "red");
		let betweenplay = new Clock("betweenplay", "orange");
		let replay = new Clock("replay", "yellow");
		let timeout = new Clock("timeout", "green");
		let commercials = new Clock("commercials", "blue");

		window.chartColors = {
			red: 'rgb(255, 99, 132)',
			orange: 'rgb(255, 159, 64)',
			yellow: 'rgb(255, 205, 86)',
			green: 'rgb(75, 192, 192)',
			blue: 'rgb(54, 162, 235)',
			purple: 'rgb(153, 102, 255)',
			grey: 'rgb(201, 203, 207)'
		};

		let pieChart = new PieChart();
		let barChart = new BarChart();

		setInterval(function() {
			if (timer.clock == null)
				return;

			pieChart.update();
			barChart.update();
		}, 1000);

	</script>
</html>
